name: Fetch orders + make POHODA XML

on:
  workflow_dispatch:
  # schedule:
  #   - cron: "0 * * * *"

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download previous state (if exists)
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: fetch.yml
          name: pohoda-state
          path: .
          if_no_artifact_found: ignore

      - name: Fetch orders (JSON)
        env:
          ESHOP_API_PASSWORD: ${{ secrets.ESHOP_API_PASSWORD }}
        run: |
          python3 scripts/fetch_orders.py

      - name: Detect new orders count
        id: new
        run: |
          python3 - << 'PY'
          import json, os
          p = "output/new_orders.json"
          try:
            with open(p, "r", encoding="utf-8") as f:
              data = json.load(f)
            n = len(data) if isinstance(data, list) else 0
          except Exception:
            n = 0
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"count={n}\n")
            f.write(f"has_new={'true' if n>0 else 'false'}\n")
          print(f"count={n}")
          PY

      - name: Make POHODA XML (only if new orders)
        if: steps.new.outputs.has_new == 'true'
        run: |
          python3 scripts/make_pohoda_xml.py

      - name: Upload outputs artifact
        uses: actions/upload-artifact@v4
        with:
          name: orders-output
          path: |
            output/orders.json
            output/new_orders.json
            output/pohoda.xml

      - name: Upload state artifact
        uses: actions/upload-artifact@v4
        with:
          name: pohoda-state
          path: |
            state.json

      - name: Send POHODA XML by email (only if new orders)
        if: steps.new.outputs.has_new == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "POHODA import – nové objednávky: ${{ steps.new.outputs.count }}"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          body: |
            Ahoj,
            v příloze posílám pohoda.xml pro import (nové objednávky: ${{ steps.new.outputs.count }}).
          attachments: |
            output/pohoda.xml
