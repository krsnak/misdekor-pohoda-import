name: Fetch orders + make POHODA XML

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "live = jen nové objednávky, test = vygeneruje XML vždy z orders.json (bez ukládání state)"
        required: true
        default: "live"
        type: choice
        options:
          - live
          - test
  schedule:
    - cron: "0 * * * *"

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (optional)
        run: |
          python -m pip install --upgrade pip
          # (legacy make_pohoda_xml.py nic navíc nepotřebuje)

      - name: Download previous state artifact (if exists) to temp folder
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: fetch.yml
          name: pohoda-state
          path: _artifact_state
          if_no_artifact_found: ignore

      - name: Use artifact state.json if present (else keep repo state.json or create default)
        run: |
          if [ -f "_artifact_state/state.json" ]; then
            echo "Using ARTIFACT state.json."
            cp _artifact_state/state.json state.json
          else
            echo "No artifact state.json found. Using REPO state.json (or default)."
          fi

          if [ ! -f state.json ]; then
            echo '{"last_id_order": 0}' > state.json
          fi

          echo "Current state.json:"
          cat state.json

      - name: Fetch orders (JSON)
        env:
          ESHOP_API_PASSWORD: ${{ secrets.ESHOP_API_PASSWORD }}
        run: |
          python3 scripts/fetch_orders.py
          ls -lah output || true

      # TEST mode: vynutí generování XML z orders.json (bez ohledu na "nové")
      - name: TEST mode - force new_orders.json from orders.json
        if: ${{ (github.event.inputs.mode || 'live') == 'test' }}
        run: |
          mkdir -p output
          cp -f output/orders.json output/new_orders.json
          echo "TEST MODE: copied output/orders.json -> output/new_orders.json"

      - name: Detect new orders count
        id: new
        run: |
          python3 - << 'PY'
          import json, os
          p = "output/new_orders.json"
          try:
            with open(p, "r", encoding="utf-8") as f:
              data = json.load(f)
            n = len(data) if isinstance(data, list) else (len(data.get("orders", [])) if isinstance(data, dict) else 0)
          except Exception:
            n = 0

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"count={n}\n")
            f.write(f"has_new={'true' if n>0 else 'false'}\n")

          print("new orders:", n)
          PY

      # Generuj XML:
      # - v LIVE jen když jsou nové
      # - v TEST vždy
      - name: Make POHODA XML (legacy)
        if: ${{ steps.new.outputs.has_new == 'true' || (github.event.inputs.mode || 'live') == 'test' }}
        run: |
          python3 scripts/make_pohoda_xml.py

          echo "Looking for generated pohoda.xml..."
          find . -maxdepth 4 -type f -iname "pohoda.xml" -print -ls || true

          mkdir -p output

          # Normalizace: zajistí output/pohoda.xml i když skript zapisuje jinam
          if [ -f output/pohoda.xml ]; then
            echo "OK: output/pohoda.xml exists"
          elif [ -f pohoda.xml ]; then
            echo "Found ./pohoda.xml -> copying to output/pohoda.xml"
            cp -f pohoda.xml output/pohoda.xml
          else
            FOUND="$(find . -maxdepth 4 -type f -iname "pohoda.xml" | head -n 1)"
            if [ -n "$FOUND" ]; then
              echo "Found $FOUND -> copying to output/pohoda.xml"
              cp -f "$FOUND" output/pohoda.xml
            else
              echo "ERROR: pohoda.xml not found anywhere (maxdepth 4)"
              echo "Output dir listing:"
              ls -lah output || true
              exit 1
            fi
          fi

          echo "Final file:"
          ls -lah output/pohoda.xml
          wc -c output/pohoda.xml

      - name: Upload outputs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: orders-output
          if-no-files-found: warn
          path: |
            output/orders.json
            output/new_orders.json
            output/pohoda.xml
            state.json

      # State ukládej jen v LIVE režimu (test ti nesmí hýbat last_id_order)
      - name: Upload state artifact
        if: ${{ (github.event.inputs.mode || 'live') == 'live' }}
        uses: actions/upload-artifact@v4
        with:
          name: pohoda-state
          path: state.json

      - name: Send POHODA XML by email
        if: ${{ steps.new.outputs.has_new == 'true' || (github.event.inputs.mode || 'live') == 'test' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          secure: false
          subject: "POHODA import – nové objednávky: ${{ steps.new.outputs.count }} (mode: ${{ github.event.inputs.mode || 'live' }})"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          body: |
            Ahoj,
            v příloze posílám pohoda.xml pro import do POHODY.
          attachments: output/pohoda.xml
          nodemailerlog: true
          nodemailerdebug: true
